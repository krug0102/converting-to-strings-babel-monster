{"version":3,"sources":["shadow/remote/runtime/tap_support.cljc"],"mappings":"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","names":["p__145625","p__145626","map__145627","cljs.core/--destructure-map","cljs.core.get","map__145628","shadow.remote.runtime.tap-support/tap-subscribe","subs-ref","obj-support","runtime","svc","from","summary","history","num","msg","cljs.core.swap_BANG_","cljs.core/assoc","shadow.remote.runtime.shared/reply","shadow.remote.runtime.obj-support/get-tap-history","cljs.core.map","oid","shadow.remote.runtime.obj-support/obj-describe*","cljs.core.into","p__145636","p__145637","map__145638","map__145639","shadow.remote.runtime.tap-support/tap-unsubscribe","cljs.core/dissoc","p__145643","p__145644","map__145645","map__145646","shadow.remote.runtime.tap-support/request-tap-history","tap-ids","p__145648","map__145649","shadow.remote.runtime.tap-support/tool-disconnect","tid","shadow.remote.runtime.tap-support/start","cljs.core.atom","tap-fn","obj","shadow.remote.runtime.obj-support/register","seq__145664","cljs.core/seq","cljs.core/deref","chunk__145665","count__145666","i__145667","vec__145678","cljs.core.nth","temp__5753__auto__","cljs.core/chunked-seq?","c__4649__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","vec__145681","cljs.core/first","cljs.core/next","tap-config","shadow.remote.runtime.api/relay-msg","p1__145654#","p1__145655#","p1__145656#","p1__145658#","shadow.remote.runtime.api/add-extension","cljs.core/add-tap","p__145685","map__145686","shadow.remote.runtime.tap-support/stop","cljs.core/remove-tap","shadow.remote.runtime.api/del-extension"],"sourcesContent":["(ns shadow.remote.runtime.tap-support\n  (:require\n    [shadow.remote.runtime.api :as p]\n    [shadow.remote.runtime.shared :as shared]\n    [shadow.remote.runtime.obj-support :as obj]))\n\n(defn tap-subscribe\n  [{:keys [subs-ref obj-support runtime] :as svc}\n   {:keys [from summary history num] :or {num 10} :as msg}]\n  (swap! subs-ref assoc from msg)\n  ;; FIXME: should this always confirm?\n  ;; tool may want to do stuff even if it didn't request a history?\n  ;; but it can do so optimistically and just receive taps?\n\n  ;; we need an option to send out the history because of concurrency issues\n  ;; otherwise it may do a :request-tap-history before :tap-subscribe\n  ;; which may cause it to miss taps inbetween\n  ;; or after which means it may have received taps before receiving the history\n  (when history\n    (shared/reply runtime msg\n      {:op :tap-subscribed\n       :history (->> (obj/get-tap-history obj-support num)\n                     ;; FIXME: only send summary if requested\n                     (map (fn [oid] {:oid oid :summary (obj/obj-describe* obj-support oid)}))\n                     (into []))})))\n\n(defn tap-unsubscribe\n  [{:keys [subs-ref]} {:keys [from]}]\n  (swap! subs-ref dissoc from))\n\n(defn request-tap-history\n  [{:keys [obj-support runtime]}\n   {:keys [num] :or {num 10} :as msg}]\n  (let [tap-ids (obj/get-tap-history obj-support num)]\n    (shared/reply runtime msg {:op :tap-history\n                               :oids tap-ids})))\n\n(defn tool-disconnect\n  [{:keys [subs-ref] :as svc} tid]\n  (swap! subs-ref dissoc tid))\n\n(defn start [runtime obj-support]\n  (let [subs-ref\n        (atom {})\n\n        tap-fn\n        (fn runtime-tap [obj]\n          (when (some? obj)\n            (let [oid (obj/register obj-support obj {:from :tap})]\n              (doseq [[tid tap-config] @subs-ref]\n                (p/relay-msg runtime {:op :tap :to tid :oid oid})))))\n\n        svc\n        {:runtime runtime\n         :obj-support obj-support\n         :tap-fn tap-fn\n         :subs-ref subs-ref}]\n\n    (p/add-extension runtime\n      ::ext\n      {:ops\n       ;; would be nicer to just pass tap-subscribe and have the runtime\n       ;; automatically pass extra args. but this makes everything REPL unfriendly\n       ;; and will require a runtime restart for every op change\n       ;; this way only adding ops requires a restart\n       {:tap-subscribe #(tap-subscribe svc %)\n        :tap-unsubscribe #(tap-unsubscribe svc %)\n        :request-tap-history #(request-tap-history svc %)}\n       :on-tool-disconnect #(tool-disconnect svc %)})\n\n    (add-tap tap-fn)\n    svc))\n\n(defn stop [{:keys [tap-fn runtime] :as svc}]\n  (remove-tap tap-fn)\n  (p/del-extension runtime ::ext))\n"]}