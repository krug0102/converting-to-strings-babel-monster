{"version":3,"sources":["repl_tooling/editor_integration/renderer/pinkie.cljs"],"mappings":"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","names":["repl-tooling.editor-integration.renderer.pinkie/norm-reagent-fn","fun","args","empty","js/Object","state","reagent.core.atom","render","cljs.core/deref","cljs.core._EQ_","promesa.protocols/-bind","___56277__auto__","___56267__auto__","promesa.protocols/-promise","res","cljs.core.apply","cljs.core/reset!","cljs.core/vector","repl-tooling.editor-integration.renderer.pinkie/register-reagent","keyword","repl-tooling.ui.pinkie/register-tag","repl-tooling.editor-integration.renderer.pinkie/norm-pinkie-fn","pinkgorilla.ui.jsrender/render-js","dom","div","js/document","upd","elem","e89467","_","cljs.core.js__GT_clj","js/Promise","repl-tooling.editor-integration.renderer.pinkie/register-tag","js/repl-tooling","js/repl-tooling.editor-integration","js/repl-tooling.editor-integration.renderer","js/repl-tooling.editor-integration.renderer.pinkie","js/repl-tooling.editor-integration.renderer.pinkie.ansi","repl-tooling.editor-integration.renderer.pinkie/ansi","js/shadow.js.shim.module$ansi_up.default","var_args","args__4835__auto__","len__4829__auto__","i__4830__auto__","argseq__4836__auto__","cljs.core/IndexedSeq","repl-tooling.editor-integration.renderer.pinkie/ansi-tag","seq89468","G__89469","cljs.core/first","cljs.core/next","self__4816__auto__","attrs","txts","vec__89470","cljs.core.nth","cljs.core/map?","cljs.core/cons","cljs.core.merge","cljs.core.assoc","cljs.core/str","repl-tooling.editor-integration.renderer.pinkie/code-tag","seq89473","G__89474","param","body","vec__89475","params","js/shadow.js.shim.module$highlight.highlight","clojure.string.join","repl-tooling.editor-integration.renderer.pinkie/markdown-tag","seq89478","self__4817__auto__","cljs.core/seq","parser","js/shadow.js.shim.module$commonmark.Parser","js/shadow.js.shim.module$commonmark.HtmlRenderer","js/document.createElement","seq__89479","chunk__89480","count__89481","i__89482","temp__5753__auto__","cljs.core/chunked-seq?","c__4649__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","n","js/shadow.js.shim.module$highlight.highlightElement"],"sourcesContent":["(ns repl-tooling.editor-integration.renderer.pinkie\n  (:require [promesa.core :as p]\n            [clojure.string :as str]\n            [reagent.core :as r]\n            [repl-tooling.ui.pinkie :as pinkie]\n            [pinkgorilla.ui.jsrender :as jsrender]\n            [\"highlight.js\" :as highlight]\n            [\"commonmark\" :refer [Parser HtmlRenderer]]\n            [\"path\" :refer [dirname join]]\n            [\"fs\" :refer [watch readFile existsSync]]\n            [\"ansi_up\" :default Ansi]))\n\n(defn- norm-reagent-fn [fun]\n  (fn [ & args]\n    (let [empty (js/Object.)\n          state (r/atom empty)\n          render (fn [ state & args]\n                   (if (= empty @state)\n                     (do\n                       (p/let [res (apply fun args)]\n                         (reset! state res))\n                       [:div.repl-tooling.icon.loading])\n                     @state))]\n      (apply vector render state args))))\n\n(defn register-reagent [keyword fun]\n  (pinkie/register-tag keyword (norm-reagent-fn fun)))\n\n(defn- norm-pinkie-fn [fun]\n  (fn [ & args]\n    [jsrender/render-js\n     {:f (fn [dom args]\n           (let [div (.createElement js/document \"div\")\n                 upd (fn [elem]\n                       (try (.removeChild dom div) (catch :default _))\n                       (.appendChild dom elem))\n                 elem (apply fun (js->clj args))]\n             (.. div -classList (add \"repl-tooling\" \"icon\" \"loading\"))\n             (.appendChild dom div)\n             (if (instance? js/Promise elem)\n               (.then elem upd)\n               (upd elem))))\n      :data args}]))\n\n(defn register-tag [keyword fun]\n  (pinkie/register-tag keyword (norm-pinkie-fn fun)))\n\n(defonce ^:private ansi (new Ansi))\n(defn ansi-tag [attrs & txts]\n  (let [[attrs txts] (if (map? attrs)\n                       [attrs txts]\n                       [{} (cons attrs txts)])\n        attrs (merge {:class \"pre block\"} attrs)]\n    [:div (assoc attrs\n                 :dangerouslySetInnerHTML\n                 #js {:__html (. ansi ansi_to_html (apply str txts))})]))\n\n(defn code-tag [ param & body]\n  (let [[params body] (if (map? param)\n                        [param body]\n                        [nil (cons param body)])]\n\n    [:pre (assoc params :class \"hljs\")\n     [:code {:dangerouslySetInnerHTML\n             {:__html\n              (.-value\n               (highlight/highlight (str/join \"\" body)\n                                    #js {:language \"clojure\"\n                                         :ignoreIllegals true}))}}]]))\n\n(defn markdown-tag [ & body]\n  (let [parser (new Parser)\n        render (new HtmlRenderer)\n        body (str/join \"\" body)\n        div (js/document.createElement \"div\")]\n    (.. div -classList (add \"rows\"))\n    (aset div \"innerHTML\" (->> body (.parse parser) (.render render)))\n    (doseq [n (.querySelectorAll div \"pre code\")]\n      (highlight/highlightElement n)\n      (.. n -parentElement -classList (add \"hljs\")))\n    div))\n"]}